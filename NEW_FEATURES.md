# ComprehendAI 新功能说明

## 🎉 重大功能升级

本次更新大幅提升了 ComprehendAI 的功能性和易用性，让 IDA 分析更加高效便捷！

---

## 📦 1. 智能缓存系统

### 功能说明
- 自动缓存分析结果，避免重复分析相同函数
- 基于函数地址和代码内容的智能缓存键
- 缓存有效期：24小时
- 自动管理缓存大小（最多100条记录）

### 使用方法
```
右键菜单 -> ComprehendAI -> 🔄 切换缓存  # 启用/禁用缓存
右键菜单 -> ComprehendAI -> 🗑️ 清空缓存  # 清除所有缓存
```

### 优势
- ✅ 节省 API 调用次数和费用
- ✅ 即时显示已分析函数的结果
- ✅ 提高工作效率

---

## 💾 2. 结果导出功能

### 功能说明
- 将分析结果导出为 Markdown 格式文档
- 包含完整的函数信息和分析结果
- 可选包含反编译代码
- 自动组织文件名（函数名_地址_时间戳）

### 使用方法
```
# 手动导出
右键菜单 -> ComprehendAI -> 💾 导出结果

# 自动导出（分析完成后自动导出）
右键菜单 -> ComprehendAI -> 📤 自动导出
```

### 导出位置
```
IDA插件目录/comprehendai_exports/
```

### 文件格式示例
```markdown
# ComprehendAI 分析报告

## 函数信息
- **函数名**: main
- **地址**: 0x401000
- **分析时间**: 2025-10-24 16:30:45

## 分析结果
[AI分析内容]

## 反编译代码
```c
[反编译代码]
```
```

---

## 🎯 3. 预设分析模板

### 可用模板

#### 🤖 标准分析（默认）
全面的代码分析，包括功能、逻辑、子函数说明

#### 🔒 安全审计
专注于安全漏洞检测：
- 缓冲区溢出
- 整数溢出/下溢
- 空指针解引用
- 未初始化变量
- 格式化字符串漏洞
- 竞态条件
- 不安全的API调用

#### 🐛 漏洞扫描
深度漏洞挖掘：
- CVE类型漏洞
- 内存安全问题
- 逻辑漏洞
- 权限绕过
- 注入攻击向量

#### 🔍 算法识别
识别代码中使用的算法：
- 加密/解密算法（AES, RSA, DES等）
- 哈希算法（MD5, SHA系列等）
- 压缩算法
- 编码算法（Base64, URL编码等）
- 数据结构算法

#### ⚡ 快速总结
简洁快速的功能总结（不超过3句话）

### 使用方法
```
右键菜单 -> ComprehendAI -> 选择对应的分析模板
例如：
- 🤖 AI 智能分析（标准）
- 🔒 安全审计
- 🐛 漏洞扫描
- 🔍 算法识别
- ⚡ 快速总结
```

---

## 📝 4. 代码上下文增强

### 功能说明
自动提取并展示函数的额外上下文信息：

- **函数基本信息**：名称、地址、大小
- **字符串常量**：函数中引用的字符串（帮助理解功能）
- **数值常量**：关键的立即数（如魔数、标志位等）

### 示例输出
```
================================================================================
函数上下文信息
================================================================================
函数名: encrypt_data
地址: 0x401500
大小: 256 字节

发现的字符串 (3 个):
  1. "AES-256-CBC"
  2. "/dev/urandom"
  3. "encryption_key.bin"

关键常量 (5 个):
  0x100, 0x200, 0x400, 0x800, 0x1000
```

### 优势
- ✅ 帮助 AI 更准确地理解代码功能
- ✅ 快速识别加密算法和重要标志
- ✅ 提供更多分析线索

---

## 🚀 5. 新增快捷菜单

### 完整菜单结构

```
ComprehendAI/
├── 🤖 AI 智能分析       # 标准分析
├── 🔒 安全审计           # 安全漏洞审计
├── 🐛 漏洞扫描           # 深度漏洞扫描
├── 🔍 算法识别           # 识别加密算法
├── ⚡ 快速总结           # 快速功能总结
├── ─────────────────
├── 💬 带代码提问         # 结合代码自定义提问
├── 💭 直接提问           # 不带代码提问
├── ─────────────────
├── 💾 导出结果           # 导出上次分析结果
├── 📤 自动导出           # 切换自动导出
├── ─────────────────
├── 🔄 切换缓存           # 启用/禁用缓存
├── 🗑️ 清空缓存           # 清除所有缓存
├── ─────────────────
├── ⚙️ 分析深度           # 设置递归深度
├── 📝 自定义提示词       # 自定义提示词模板
├── ─────────────────
└── 🛑 停止               # 停止当前任务
```

---

## 📊 6. 性能优化

### 改进内容

1. **返回值优化**
   - AI服务现在返回分析结果和状态
   - 支持结果缓存和导出

2. **代码提取增强**
   - 返回反汇编代码和函数地址的元组
   - 支持选择性提取上下文信息

3. **线程安全改进**
   - 更完善的锁管理
   - 确保资源正确释放

---

## 🎮 使用场景

### 场景1：快速分析未知函数
```
1. 右键函数 -> ⚡ 快速总结
2. 查看简短总结
3. 如需详细分析 -> 🤖 AI 智能分析
```

### 场景2：安全审计
```
1. 右键可疑函数 -> 🔒 安全审计
2. 查看安全风险评估
3. 针对性分析 -> 🐛 漏洞扫描
4. 导出报告 -> 💾 导出结果
```

### 场景3：算法识别
```
1. 右键加密函数 -> 🔍 算法识别
2. 快速确认使用的加密算法
3. 结合字符串常量验证
```

### 场景4：批量分析
```
1. 启用缓存 -> 🔄 切换缓存
2. 启用自动导出 -> 📤 自动导出
3. 依次分析多个函数
4. 所有结果自动缓存和导出
```

---

## 💡 最佳实践

### 1. 缓存管理
- 默认启用缓存以节省 API 调用
- 代码修改后清空对应函数的缓存
- 定期清空缓存以节省磁盘空间

### 2. 分析深度设置
- **深度0**：只分析当前函数（最快，最省token）
- **深度1**：包含直接调用的子函数
- **深度2**：包含两层子函数（默认，推荐）
- **深度3+**：深度分析（耗时，消耗大量token）

### 3. 模板选择
- 初次分析：使用**标准分析**
- 安全重点：使用**安全审计**或**漏洞扫描**
- 快速浏览：使用**快速总结**
- 密码学相关：使用**算法识别**

### 4. 结果管理
- 重要分析：手动导出保存
- 批量分析：启用自动导出
- 定期整理导出目录

---

## 🔧 配置建议

### 适合节省成本
```
1. 启用缓存 ✅
2. 设置深度为 0 或 1
3. 优先使用快速总结
4. 关闭自动导出
```

### 适合深度分析
```
1. 启用缓存 ✅
2. 设置深度为 2 或 3
3. 使用标准分析或专业模板
4. 启用自动导出 ✅
```

### 适合安全审计
```
1. 启用缓存 ✅
2. 设置深度为 2
3. 使用安全审计/漏洞扫描
4. 启用自动导出 ✅
5. 定期导出报告
```

---

## 📈 性能对比

### 优化前 vs 优化后

| 功能 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 重复分析同一函数 | 每次都调用API | 使用缓存 | ⚡ 即时响应 |
| 结果保存 | 需手动复制 | 一键导出 | ✅ 自动保存 |
| 分析类型 | 仅标准分析 | 5种专业模板 | 🎯 更专业 |
| 上下文信息 | 仅反编译代码 | 包含字符串、常量 | 📊 更全面 |
| 菜单项 | 6个 | 14个 | 🚀 功能翻倍 |

---

## 🎓 高级技巧

### 1. 组合使用
```
1. 快速总结 -> 了解大致功能
2. 标准分析 -> 详细理解逻辑
3. 安全审计 -> 检查安全问题
4. 导出结果 -> 保存分析报告
```

### 2. 自定义工作流
```
# 安全审计工作流
1. 启用缓存 + 自动导出
2. 设置深度为 2
3. 对所有可疑函数使用"安全审计"
4. 对高风险函数使用"漏洞扫描"
5. 整理导出的报告
```

### 3. 提示词优化
```
# 针对特定项目自定义提示词
1. 右键 -> 📝 自定义提示词
2. 添加项目特定的分析要求
3. 例如："这是一个Android native库，重点关注JNI调用"
```

---

## 🐛 故障排除

### 缓存相关
**Q: 缓存的函数修改后如何更新？**
A: 清空缓存（🗑️）或禁用缓存后重新分析

**Q: 缓存存储在哪里？**
A: `IDA插件目录/comprehendai_cache/cache.json`

### 导出相关
**Q: 找不到导出的文件？**
A: 检查 `IDA插件目录/comprehendai_exports/` 目录

**Q: 导出失败？**
A: 确保插件目录有写入权限

### 性能相关
**Q: 分析太慢？**
A: 
1. 降低分析深度
2. 使用快速总结模板
3. 检查网络连接

---

## 📝 更新日志

### v2.0 - 2025-10-24

#### 新增功能
- ✨ 智能缓存系统
- ✨ 结果导出功能
- ✨ 5种预设分析模板
- ✨ 代码上下文提取（字符串、常量）
- ✨ 自动导出开关
- ✨ 缓存管理功能

#### 改进
- 🚀 AI服务返回结果和状态
- 🚀 DisassemblyProcessor 返回地址
- 🚀 完善的错误处理
- 🚀 更好的用户反馈

#### 代码质量
- 📦 新增6个功能类
- 📝 完整的类型注解
- 📚 详细的文档字符串
- 🧪 线程安全改进

---

## 🙏 感谢使用

ComprehendAI 致力于让逆向分析更加高效智能！

如有问题或建议，欢迎提交 Issue！

